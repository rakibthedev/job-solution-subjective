<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Subjective Job Solution | Job Study Hub BD</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="shortcut icon" href="icons/icon-192.png" type="image/x-icon">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="hamburger" id="hamburger"><i class="fas fa-bars"></i></div>

<div class="container-wrapper">
  <div class="sidebar" id="sidebar"></div>
  <div class="main-container">
    <div id="headerDiv" class="header"></div>
    <div id="questions"></div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<div class="counter" id="counter">R: 0 | W: 0</div>

<script>
const mcqs = {
  "à¦¬à¦¾à¦‚à¦²à¦¾ à¦¸à¦¾à¦¹à¦¿à¦¤à§à¦¯":"./mcq/bangla_sahitto.json",
  "à¦¬à¦¾à¦‚à¦²à¦¾ à¦­à¦¾à¦·à¦¾ à¦“ à¦¬à§à¦¯à¦¾à¦•à¦°à¦£":"./mcq/bangla_bakoron.json",
};

let data={header:[],questions:[]}, currentPage=1, currentExamKey=null;
const perPage=50;

const sidebar=document.getElementById('sidebar');
const headerDiv=document.getElementById('headerDiv');
const questionsDiv=document.getElementById('questions');
const paginationDiv=document.getElementById('pagination');
const counterDiv=document.getElementById('counter');
const hamburger=document.getElementById('hamburger');

// Hamburger toggle
hamburger.addEventListener('click',()=>{ sidebar.classList.toggle('show'); });

// Build sidebar
for(let exam in mcqs){
  const div=document.createElement('div');
  div.textContent=exam;
  div.addEventListener('click', ()=>{
    if(div.classList.contains("active")) return;
    document.querySelectorAll('.sidebar div').forEach(d=>d.classList.remove('active'));
    div.classList.add('active');
    loadExam(mcqs[exam], exam);
    if(window.innerWidth<=700) sidebar.classList.remove('show');
  });
  sidebar.appendChild(div);
}

// Load first exam onload
window.addEventListener('DOMContentLoaded',()=>{
  const firstExam=Object.keys(mcqs)[0];
  document.querySelector('.sidebar div').classList.add('active');
  loadExam(mcqs[firstExam], firstExam);
});

function loadExam(file, examKey){
  currentExamKey = examKey;
  fetch(file)
    .then(res=>res.json())
    .then(json=>{
      const firstHeaderObj=json.find(item=>item.header);
      const header=firstHeaderObj?.header||[];
      const questions=json.filter(item=>item.label);
      questions.forEach(q=>q.selected=null);

      data={header,questions};

      // ðŸ§  LocalStorage: Try to restore previous state
      const saved = localStorage.getItem(`mcq_${examKey}`);
      if(saved){
        try {
          const parsed = JSON.parse(saved);
          currentPage = parsed.page || 1;
          data.questions.forEach((q,idx)=>{
            if(parsed.selected && parsed.selected[idx]!==undefined){
              q.selected = parsed.selected[idx];
            }
          });
        } catch(e){ console.warn("Restore failed",e); }
      } else {
        currentPage=1;
      }

      updateCounter();
      headerDiv.innerHTML=header.map(h=>`<div>${h}</div>`).join('');
      renderPage(currentPage);
    })
    .catch(err=>console.error('Failed to load exam:',err));
}

// ðŸ§  LocalStorage: Save progress
function saveProgress(){
  if(!currentExamKey) return;
  const selected = data.questions.map(q=>q.selected);
  localStorage.setItem(`mcq_${currentExamKey}`, JSON.stringify({
    page: currentPage,
    selected
  }));
}

// Update right/wrong counter from data
function updateCounter(){
  let right=0, wrong=0;
  data.questions.forEach(q=>{
    if(q.selected){
      if(q.selected===q.answer) right++;
      else wrong++;
    }
  });
  counterDiv.textContent=`R: ${right} | W: ${wrong}`;
  saveProgress(); // ðŸ§  auto-save after counter update
}

function renderPage(page){
  questionsDiv.innerHTML='';
  const start=(page-1)*perPage;
  const end=Math.min(start+perPage,data.questions.length);
  const pageQuestions=data.questions.slice(start,end);

  pageQuestions.forEach((q,idx)=>{
    const card=document.createElement('div'); card.className='question-card';
    const label=document.createElement('div'); label.className='question-label';
    label.textContent=`${start+idx+1}. ${q.label}`; card.appendChild(label);

    const optionsDiv=document.createElement('div'); optionsDiv.className='options';
    q.options.forEach((opt,oidx)=>{
      const optionEl=document.createElement('div'); 
      optionEl.className='option';
      optionEl.textContent=opt;

      const thisKey=['a','b','c','d'][oidx];

      // restore state if answered before
      if(q.selected){
        optionEl.classList.add('disabled');
        if(thisKey===q.answer){
          optionEl.classList.add('correct');
        }
        if(thisKey===q.selected && q.selected!==q.answer){
          optionEl.classList.add('wrong');
        }
      }

      optionEl.addEventListener('click',()=>{
        if(q.selected) return; // already answered, block further
        q.selected=thisKey;

        optionsDiv.querySelectorAll('.option').forEach(o=>o.classList.add('disabled'));
        if(q.selected===q.answer){
          optionEl.classList.add('correct');
        } else {
          optionEl.classList.add('wrong');
          const rightBtn=optionsDiv.querySelector(`.option:nth-child(${q.answer.charCodeAt(0)-97+1})`);
          if(rightBtn) rightBtn.classList.add('correct');
        }
        updateCounter(); // ðŸ§  auto-save triggered inside
      });

      optionsDiv.appendChild(optionEl);
    });

    card.appendChild(optionsDiv);
    questionsDiv.appendChild(card);
  });
  renderPagination(page);
}

function renderPagination(page){
  paginationDiv.innerHTML='';
  const totalPages = Math.ceil(data.questions.length / perPage);

  const addPageBtn=(num)=>{
    const btn=document.createElement('button');
    btn.textContent=num;
    if(num===page) btn.classList.add('disabled');
    btn.addEventListener('click',()=>{
      currentPage=num;
      renderPage(currentPage);
      saveProgress(); // ðŸ§  save on page change
    });
    paginationDiv.appendChild(btn);
  };

  const firstBtn=document.createElement('button');
  firstBtn.textContent='<<';
  firstBtn.disabled=page===1;
  if(page===1) firstBtn.classList.add('disabled');
  firstBtn.addEventListener('click',()=>{currentPage=1; renderPage(currentPage); saveProgress();});
  paginationDiv.appendChild(firstBtn);

  const prevBtn=document.createElement('button');
  prevBtn.textContent='<';
  prevBtn.disabled=page===1;
  if(page===1) prevBtn.classList.add('disabled');
  prevBtn.addEventListener('click',()=>{currentPage--; renderPage(currentPage); saveProgress();});
  paginationDiv.appendChild(prevBtn);

  let start=Math.max(1, page-1);
  let end=Math.min(totalPages, page+1);
  for(let i=start; i<=end; i++){ addPageBtn(i); }

  const nextBtn=document.createElement('button');
  nextBtn.textContent='>';
  nextBtn.disabled=page===totalPages;
  if(page===totalPages) nextBtn.classList.add('disabled');
  nextBtn.addEventListener('click',()=>{currentPage++; renderPage(currentPage); saveProgress();});
  paginationDiv.appendChild(nextBtn);

  const lastBtn=document.createElement('button');
  lastBtn.textContent='>>';
  lastBtn.disabled=page===totalPages;
  if(page===totalPages) lastBtn.classList.add('disabled');
  lastBtn.addEventListener('click',()=>{currentPage=totalPages; renderPage(currentPage); saveProgress();});
  paginationDiv.appendChild(lastBtn);

  const jumpDiv=document.createElement('div');
  jumpDiv.style.marginTop='10px';

  const input=document.createElement('input');
  input.type='number';
  input.min=1;
  input.max=totalPages;
  input.placeholder=`${currentPage}/${totalPages}`;
  input.style.width='100px';
  input.style.marginRight='5px';
  input.style.padding='5px';
  input.style.border='1px solid #6a1b9a';
  input.style.borderRadius='4px';

  const jumpBtn=document.createElement('button');
  jumpBtn.style.padding = "7px 16px";
  jumpBtn.textContent='Go';
  jumpBtn.addEventListener('click',()=>{
    let num=parseInt(input.value,10);
    if(!isNaN(num) && num>=1 && num<=totalPages){
      currentPage=num;
      renderPage(currentPage);
      saveProgress();
    }
  });

  jumpDiv.appendChild(input);
  jumpDiv.appendChild(jumpBtn);
  paginationDiv.appendChild(jumpDiv);
}

// Floating Reset button
const resetBtn = document.createElement('button');
resetBtn.textContent = 'âŸ² Reset';
resetBtn.style.position = 'fixed';
resetBtn.style.bottom = '225px';
resetBtn.style.left = '0';
resetBtn.style.background = '#d32f2f';
resetBtn.style.color = '#fff';
resetBtn.style.border = 'none';
resetBtn.style.padding = '6px 12px';
resetBtn.style.cursor = 'pointer';
resetBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
resetBtn.style.borderTopRightRadius = '10px';
resetBtn.style.borderBottomRightRadius = '10px';
resetBtn.style.zIndex = '9999';
document.body.appendChild(resetBtn);

// ðŸ§  Reset click action
resetBtn.addEventListener('click', () => {
  if (!currentExamKey) return;
  if (!confirm("Are you sure you want to reset this exam progress?")) return;

  localStorage.removeItem(`mcq_${currentExamKey}`);
  data.questions.forEach(q => q.selected = null);
  currentPage = 1;
  updateCounter();
  renderPage(currentPage);
});

// Floating Go Top/Bottom button (same)
const scrollBtn = document.createElement('button');
scrollBtn.textContent = 'â†“ Bottom';
scrollBtn.style.position = 'fixed';
scrollBtn.style.bottom = '20px';
scrollBtn.style.right = '0';
scrollBtn.style.background = '#6a1b9a';
scrollBtn.style.color = '#fff';
scrollBtn.style.border = 'none';
scrollBtn.style.padding = '6px 11px';
scrollBtn.style.cursor = 'pointer';
scrollBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
scrollBtn.style.borderTopLeftRadius = '10px';
scrollBtn.style.borderBottomLeftRadius = '10px';
scrollBtn.style.zIndex = '9999';
document.body.appendChild(scrollBtn);

scrollBtn.addEventListener('click', () => {
  if (scrollBtn.textContent === 'â†“ Bottom') {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  } else {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
});

function updateBtnLabel() {
  const scrollTop = window.scrollY;
  const docHeight = document.body.scrollHeight - window.innerHeight;
  const scrolledPercent = (scrollTop / docHeight) * 100;

  if (scrolledPercent > 10) {
    scrollBtn.textContent = 'â†‘ Top';
  } else {
    scrollBtn.textContent = 'â†“ Bottom';
  }
}
window.addEventListener('scroll', updateBtnLabel);

// Register SW
// if('serviceWorker' in navigator){
//   navigator.serviceWorker.register('./sw.js')
//     .then(reg=>{
//       console.log('SW registered', reg);

//       function sendMCQs(){
//         if(reg.active){
//           reg.active.postMessage({type:'CACHE_MCQS', mcqs:Object.values(mcqs)});
//         } else {
//           navigator.serviceWorker.ready.then(r=>r.active.postMessage({type:'CACHE_MCQS', mcqs:Object.values(mcqs)}));
//         }
//       }

//       sendMCQs();
//     })
//     .catch(err=>console.error('SW registration failed',err));
// }
</script>

</body>
</html>
