<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MCQ Exam App</title>
<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="shortcut icon" href="icons/icon-192.png" type="image/x-icon">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="hamburger" id="hamburger"><i class="fas fa-bars"></i></div>

<div class="container-wrapper">
  <div class="sidebar" id="sidebar"></div>
  <div class="main-container">
    <div id="headerDiv" class="header"></div>
    <div id="questions"></div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<div class="counter" id="counter">R: 0 | W: 0</div>

<script>
const mcqs = {
  "বাংলা সাহিত্য":"./mcq/bangla_sahitto.json",
  "বাংলা ভাষা ও ব্যাকরণ":"./mcq/bangla_bakoron.json",
};

let data={header:[],questions:[]}, currentPage=1, right=0, wrong=0;
const perPage=50;

const sidebar=document.getElementById('sidebar');
const headerDiv=document.getElementById('headerDiv');
const questionsDiv=document.getElementById('questions');
const paginationDiv=document.getElementById('pagination');
const counterDiv=document.getElementById('counter');
const hamburger=document.getElementById('hamburger');

// Hamburger toggle
hamburger.addEventListener('click',()=>{ sidebar.classList.toggle('show'); });

// Build sidebar
for(let exam in mcqs){
  const div=document.createElement('div');
  div.textContent=exam;
  div.addEventListener('click', ()=>{
    if(div.classList.contains("active")) return;
    document.querySelectorAll('.sidebar div').forEach(d=>d.classList.remove('active'));
    div.classList.add('active');
    loadExam(mcqs[exam]);
    if(window.innerWidth<=700) sidebar.classList.remove('show');
  });
  sidebar.appendChild(div);
}

// Load first exam onload
window.addEventListener('DOMContentLoaded',()=>{
  const firstExam=Object.keys(mcqs)[0];
  document.querySelector('.sidebar div').classList.add('active');
  loadExam(mcqs[firstExam]);
});

function loadExam(file){
  fetch(file)
    .then(res=>res.json())
    .then(json=>{
      const firstHeaderObj=json.find(item=>item.header);
      const header=firstHeaderObj?.header||[];
      const questions=json.filter(item=>item.label);
      data={header,questions};
      currentPage=1; right=0; wrong=0;
      counterDiv.textContent=`R: ${right} | W: ${wrong}`;
      headerDiv.innerHTML=header.map(h=>`<div>${h}</div>`).join('');
      renderPage(currentPage);
    })
    .catch(err=>console.error('Failed to load exam:',err));
}

let userAnswers = {}; // { questionIndex: selectedOptionIndex }

// Render one page
function renderPage(page){
  questionsDiv.innerHTML='';
  const start=(page-1)*perPage;
  const end=Math.min(start+perPage, data.questions.length);

  for(let i=start;i<end;i++){
    const q=data.questions[i];
    const qDiv=document.createElement('div');
    qDiv.className='question';

    const qTitle=document.createElement('h3');
    qTitle.textContent=`Q${i+1}. ${q.label}`;
    qDiv.appendChild(qTitle);

    q.options.forEach((opt,idx)=>{
      const btn=document.createElement('button');
      btn.textContent=opt;

      // restore saved answer highlight
      if(userAnswers[i] !== undefined){
        if(userAnswers[i]===idx){
          if(idx===q.answer){
            btn.classList.add('correct');
          } else {
            btn.classList.add('wrong');
          }
        }
        if(idx===q.answer && userAnswers[i]!==idx){
          btn.classList.add('correct');
        }
      }

      btn.addEventListener('click',()=>{
        userAnswers[i]=idx;
        renderPage(page); // re-render to update highlight
      });
      qDiv.appendChild(btn);
    });

    questionsDiv.appendChild(qDiv);
  }

  renderPagination(page);
}

function renderPagination(page){
  paginationDiv.innerHTML='';
  const totalPages = Math.ceil(data.questions.length / perPage);

  const addPageBtn=(num)=>{
    const btn=document.createElement('button');
    btn.textContent=num;
    if(num===page) btn.classList.add('disabled');
    btn.addEventListener('click',()=>{
      currentPage=num;
      renderPage(currentPage);
    });
    paginationDiv.appendChild(btn);
  };

  // First button
  const firstBtn=document.createElement('button');
  firstBtn.textContent='<<';
  firstBtn.disabled=page===1;
  if(page===1) firstBtn.classList.add('disabled');
  firstBtn.addEventListener('click',()=>{currentPage=1; renderPage(currentPage);});
  paginationDiv.appendChild(firstBtn);

  // Prev button
  const prevBtn=document.createElement('button');
  prevBtn.textContent='<';
  prevBtn.disabled=page===1;
  if(page===1) prevBtn.classList.add('disabled');
  prevBtn.addEventListener('click',()=>{currentPage--; renderPage(currentPage);});
  paginationDiv.appendChild(prevBtn);

  // Pages (show 2 before, current, 2 after)
  let start=Math.max(1, page-2);
  let end=Math.min(totalPages, page+2);

  for(let i=start; i<=end; i++){
    addPageBtn(i);
  }

  // Next button
  const nextBtn=document.createElement('button');
  nextBtn.textContent='>';
  nextBtn.disabled=page===totalPages;
  if(page===totalPages) nextBtn.classList.add('disabled');
  nextBtn.addEventListener('click',()=>{currentPage++; renderPage(currentPage);});
  paginationDiv.appendChild(nextBtn);

  // Last button
  const lastBtn=document.createElement('button');
  lastBtn.textContent='>>';
  lastBtn.disabled=page===totalPages;
  if(page===totalPages) lastBtn.classList.add('disabled');
  lastBtn.addEventListener('click',()=>{currentPage=totalPages; renderPage(currentPage);});
  paginationDiv.appendChild(lastBtn);

  // Jump-to-page input + button
  const jumpDiv=document.createElement('div');
  jumpDiv.style.marginTop='10px';

  const input=document.createElement('input');
  input.type='number';
  input.min=1;
  input.max=totalPages;
  input.placeholder=`${currentPage}/${totalPages}`;
  input.style.width='100px';
  input.style.marginRight='5px';
  input.style.padding='5px';
  input.style.border='1px solid #6a1b9a';
  input.style.borderRadius='4px';
  

  const jumpBtn=document.createElement('button');
  jumpBtn.style.padding = "7px 16px";
  jumpBtn.textContent='Go';
  jumpBtn.addEventListener('click',()=>{
    let num=parseInt(input.value,10);
    if(!isNaN(num) && num>=1 && num<=totalPages){
      currentPage=num;
      renderPage(currentPage);
    }
  });
  

  jumpDiv.appendChild(input);
  jumpDiv.appendChild(jumpBtn);
  paginationDiv.appendChild(jumpDiv);
}



// Floating "Go Top/Bottom" button
const scrollBtn = document.createElement('button');
scrollBtn.textContent = '↓ Bottom'; // initial
scrollBtn.style.position = 'fixed';
scrollBtn.style.bottom = '20px';
scrollBtn.style.right = '0';
scrollBtn.style.background = '#6a1b9a'; // purple tone
scrollBtn.style.color = '#fff';
scrollBtn.style.border = 'none';
scrollBtn.style.padding = '7px 10px';
scrollBtn.style.cursor = 'pointer';
scrollBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
scrollBtn.style.borderTopLeftRadius = '10px';
scrollBtn.style.borderBottomLeftRadius = '10px';
scrollBtn.style.zIndex = '9999';

document.body.appendChild(scrollBtn);

// Button click action
scrollBtn.addEventListener('click', () => {
  if (scrollBtn.textContent === '↓ Bottom') {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  } else {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
});

// Toggle label based on scroll position
function updateBtnLabel() {
  const scrollTop = window.scrollY;
  const docHeight = document.body.scrollHeight - window.innerHeight;
  const scrolledPercent = (scrollTop / docHeight) * 100;

  if (scrolledPercent > 10) {
    scrollBtn.textContent = '↑ Top';
  } else {
    scrollBtn.textContent = '↓ Bottom';
  }
}

window.addEventListener('scroll', updateBtnLabel);




// Register SW
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js')
    .then(reg=>{
      console.log('SW registered', reg);

      function sendMCQs(){
        if(reg.active){
          reg.active.postMessage({type:'CACHE_MCQS', mcqs:Object.values(mcqs)});
          
        } else {
          navigator.serviceWorker.ready.then(r=>r.active.postMessage({type:'CACHE_MCQS', mcqs:Object.values(mcqs)}));
        }
      }

      sendMCQs();

      // Optional: if mcqs object may change dynamically, call sendMCQs() again
    })
    .catch(err=>console.error('SW registration failed',err));
}
</script>

</body>
</html>
